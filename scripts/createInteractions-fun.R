# Load confidence score matrices by option
# Overwrites util.R write.mat!
write.mat <- function(mat, outpath, combo, type, used.cut, append = FALSE) {
  filename = paste0(outpath, combo, "_", type, "_", used.cut, "_cs-cut_", Sys.Date(), ".csv")
  println(paste("Writing matrix to file:", filename))
  # no column names when appending (otherwise it will be treated as random data entry by Cytoscape)
  write.table(mat, file = filename, append = append, sep = ",", row.names = FALSE, col.names = !append)
}

# Takes a combined matrix file and transforms it to a list of node-node interactions that can be loaded into Cytoscape
create.interactions <- function(combomat, outpath, combo, type, pos.edge = "positive", neg.edge = "negative", append = FALSE) {
  println("Transforming matrix to node-node-value list.")
  
  # Select top 20% of edges from signed combined matrix
  m.cut <- quantile(combomat, probs=.97)
  
  # Set which cut value is used (quantile m.cut or defined cs.abs.cut)
  used.cut = GLOBAL[["cs.abs.cut"]]
  println(paste("Using absolute confidence score cut:", used.cut))
  
  # Info about the total number of edges
  tot <- length(combomat[abs(combomat) > used.cut])
  println(paste0(tot, " [", pos.edge, "]"))
  
  # Pre-allocate data table since final dimensions are known - performance is much better than dynamic resize
  cyt.table <- data.table("nodeA"=as.character(rep(NA, tot)), "interaction"=as.character(rep("neutral", tot)), 
                          "nodeB"=as.character(rep(NA, tot)), "confidence_score"=as.double(rep(0, tot)))
  
  # Fill table with values from the combined matrix
  listrow <- 1
  # Iterate over TFs (columns)
  for (i in 1:ncol(combomat)) {
    if(i%%100==0) cat("\r", paste0("Progress: ", round((i*100/nrow(combomat)), digits = 0), "%"))
    # Per TF, only look at genes with absolute interaction value over the cutoff
    target.genes <- which(abs(combomat[,i]) > used.cut)
    if(length(target.genes) == 0) {
      println(paste("No targets found. Skipping", colnames(combomat)[i]))
      next
    }
    for (j in 1:length(target.genes)) {
      gene <- target.genes[j]
      val <- combomat[gene, i]
      
      if(abs(val) > used.cut) {
        edge.type <- pos.edge
      } else if(abs(val) < used.cut) {
        edge.type <- neg.edge
      } else {
        next # do not set any edge (list size limited to 'tot')
      }
      
      set(cyt.table, as.integer(listrow), "nodeA", colnames(combomat)[i])
      set(cyt.table, as.integer(listrow), "interaction", edge.type)
      set(cyt.table, as.integer(listrow), "nodeB", rownames(combomat)[gene])
      set(cyt.table, as.integer(listrow), "confidence_score", val)
      
      listrow <- listrow + 1
    }
  }
  cat("\n")
  write.mat(cyt.table, outpath, combo, type, used.cut, append)
  println("Done creating data table for Cytoscape.")
}